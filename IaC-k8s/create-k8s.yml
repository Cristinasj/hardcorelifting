az group create --name rke-cluster-rg --location eastus

# VNet + Subnet
az network vnet create \
  --resource-group rke-cluster-rg \
  --name rke-vnet \
  --subnet-name rke-subnet

# Bastion NSG
az network nsg create \
  --resource-group rke-cluster-rg \
  --name bastion-nsg

az network nsg rule create \
  --resource-group rke-cluster-rg \
  --nsg-name bastion-nsg \
  --name allow-ssh \
  --priority 1000 \
  --protocol Tcp \
  --destination-port-ranges 22 \
  --access Allow

# Public IP for Bastion
az network public-ip create \
  --resource-group rke-cluster-rg \
  --name bastion-pip \
  --sku Standard \
  --allocation-method static

# Bastion VM
az vm create \
  --resource-group rke-cluster-rg \
  --name rke-bastion \
  --image Ubuntu2204 \
  --size Standard_B1ms \
  --admin-username azureuser \
  --ssh-key-values ~/.ssh/id_rsa.pub \
  --vnet-name rke-vnet \
  --subnet rke-subnet \
  --nsg bastion-nsg \
  --public-ip-address bastion-pip

# Cluster NSG (K8s ports, only internal access)
az network nsg create \
  --resource-group rke-cluster-rg \
  --name cluster-nsg

az network nsg rule create \
  --resource-group rke-cluster-rg \
  --nsg-name cluster-nsg \
  --name allow-internal-k8s \
  --priority 1000 \
  --protocol Tcp \
  --source-address-prefixes 10.0.0.0/16 \
  --destination-port-ranges 22 6443 2379 2380 10250-10252 30000-32767 \
  --access Allow

# Create 3 nodes (private only, no public IPs)
for i in 1 2 3; do
  az vm create \
    --resource-group rke-cluster-rg \
    --name rke-node-$i \
    --image Ubuntu2204 \
    --size Standard_B1ms \
    --admin-username azureuser \
    --ssh-key-values ~/.ssh/id_rsa.pub \
    --vnet-name rke-vnet \
    --subnet rke-subnet \
    --nsg cluster-nsg \
    --public-ip-address ""   # <--- NO PUBLIC IP
done